"""
This file is to further extract information that can be used to visualise the vulnerability patterns. 
"""

import csv
import re
import collections
from pprint import pprint

# Count the vulnerable vendors
def get_vendor_trend():
    from data.asset_vulnerability_dict_July.vendor_product_2019July.rtu_vendor_product import rtu_vendor_product_list
    rtu_vendor_list = divide_vendors(rtu_vendor_product_list)
    print("rtu_vendor_list", rtu_vendor_list)

def divide_vendors(list):
    vendor_list = []
    for item in list:
        text_split = item.split(':')
        vendor = text_split[0]
        vendor_list.append(vendor)
    counter=collections.Counter(vendor_list)
    return counter

# Count the reported vulnerabilities per year
def get_cve_year_trend():
    from data.asset_vulnerability_dict_July.cveID_2019July.rtu_cve_id import rtu_cve_id_list
    rtu_year_list = divide_years(rtu_cve_id_list)
    print("rtu_year_list", rtu_year_list)

def divide_years(list):
    year_list = []
    for item in list:
        text_split = item.split('-')
        year = text_split[1]
        year_list.append(year)
    counter=collections.Counter(year_list)
    return counter

# Count the vulnerable component of the asset
def get_type_of_assets_vulnerable_components():
    from data.asset_vulnerability_dict_July.vulnerable_component_2019July.rtu_vulnerable_component import rtu_vulnerable_component_list
    rtu_number_of_vulnerable_hardware, rtu_number_of_vulnerable_operating, rtu_number_of_vulnerable_software = get_type_of_vulnerable_components(rtu_vulnerable_component_list)

    print('rtu_number_of_vulnerable_hardware: ' + str(rtu_number_of_vulnerable_hardware))
    print('rtu_number_of_vulnerable_operating: ' + str(rtu_number_of_vulnerable_operating))
    print('rtu_number_of_vulnerable_software: ' + str(rtu_number_of_vulnerable_software))

    
# Count the vulnerable component of the asset. while considering different versions as different instances
def get_type_of_assets_vulnerable_versions():
    from data.asset_vulnerability_dict_July.vulnerable_version_2019July.rtu_vulnerable_component_version import rtu_vulnerable_component_version_list
    rtu_number_of_vulnerable_hardware, rtu_number_of_vulnerable_operating, rtu_number_of_vulnerable_software = get_type_of_vulnerable_components(rtu_vulnerable_component_version_list)
 
    print('rtu_number_of_vulnerable_hardware: ' + str(rtu_number_of_vulnerable_hardware))
    print('rtu_number_of_vulnerable_operating: ' + str(rtu_number_of_vulnerable_operating))
    print('rtu_number_of_vulnerable_software: ' + str(rtu_number_of_vulnerable_software))

    
def get_type_of_vulnerable_components(list):
    number_of_vulnerable_hardware = 0
    number_of_vulnerable_operating = 0
    number_of_vulnerable_software = 0
    for item in list:
        text_split = item.split(':')
        component_type = text_split[0]
        if component_type == 'software application':
            number_of_vulnerable_software = number_of_vulnerable_software + 1
        if component_type == 'operating system':
            number_of_vulnerable_operating = number_of_vulnerable_operating + 1
        if component_type == 'hardware device':
            number_of_vulnerable_hardware = number_of_vulnerable_hardware + 1
    return(number_of_vulnerable_hardware, number_of_vulnerable_operating, number_of_vulnerable_software)


# Count the numbers of different threats categories.
def get_category_of_asset_threat(asset):
    file_name = asset + '_vulnerability_threat_information.csv'
    csv_file = csv.reader(open( '../data/asset_vulnerability_dict_July/threat_csv_2019July/' + file_name, "r"))
    asset_unknown_threat = 0
    asset_memc = 0
    asset_bypass = 0
    asset_csrf = 0
    asset_dirtra = 0
    asset_dos = 0
    asset_execution = 0
    asset_fileinc = 0
    asset_gainpre = 0
    asset_httprs = 0
    asset_infor = 0
    asset_overflow = 0
    asset_sqli = 0
    asset_xss = 0
    for row in csv_file:
        text_list = row[5]
        if len(text_list) > 0 and text_list[0] != 'Threat_Type':
            memc_number = text_list.count('Memory Corruption')
            asset_memc = asset_memc + memc_number
            bypass_number = text_list.count('Bypass Something')
            asset_bypass = asset_bypass + bypass_number
            csrf_number = text_list.count('Cross-Site Request Forgery')
            asset_csrf = asset_csrf + csrf_number
            dirtra_number = text_list.count('Directory Traversal')
            asset_dirtra = asset_dirtra + dirtra_number
            dos_number = text_list.count('Denial of Service')
            asset_dos = asset_dos + dos_number
            execution_number = text_list.count('Execute Code')
            asset_execution = asset_execution + execution_number
            fileinc_number = text_list.count('File Inclusion')
            asset_fileinc = asset_fileinc + fileinc_number
            gainpre_number = text_list.count('Gain Privilege')
            asset_gainpre = asset_gainpre + gainpre_number
            httprs_number = text_list.count('Http Response Splitting')
            asset_httprs = asset_httprs + httprs_number
            infor_number = text_list.count('Gain Informatio')
            asset_infor = asset_infor + infor_number
            overflow_number = text_list.count('Overflow')
            asset_overflow = asset_overflow + overflow_number
            sqli_number = text_list.count('Sql Injection')
            asset_sqli = asset_sqli + sqli_number
            xss_number = text_list.count('Cross Site Scripting')
            asset_xss = asset_xss + xss_number
        elif not len(text_list):
            asset_unknown_threat = asset_unknown_threat + 1
    print(str(asset) + ": memc: " + str(asset_memc))
    print(str(asset) + ": bypass: " + str(asset_bypass))
    print(str(asset) + ": csrf: " + str(asset_csrf))
    print(str(asset) + ": dirtra: " + str(asset_dirtra))
    print(str(asset) + ": dos: " + str(asset_dos))
    print(str(asset) + ": execution: " + str(asset_execution))
    print(str(asset) + ": fileinc: " + str(asset_fileinc))
    print(str(asset) + ": gainpre: " + str(asset_gainpre))
    print(str(asset) + ": httprs: " + str(asset_httprs))
    print(str(asset) + ": infor: " + str(asset_infor))
    print(str(asset) + ": overflow: " + str(asset_overflow))
    print(str(asset) + ": sqli: " + str(asset_sqli))
    print(str(asset) + ": xss: " + str(asset_xss))
    print(str(asset) + ": unknown_threat: " + str(asset_unknown_threat))


# Count the average CVSS v2 base-score.
def get_average_score_of_asset_threat_for_cvss_two(asset):
    score_list = []
    Low = 0
    Medium = 0
    High = 0
    file_name = asset + '_vulnerability_threat_information.csv'
    csv_file = csv.reader(open( '../data/asset_vulnerability_dict_July/threat_csv_2019July/' + file_name, "r"))
    for row in csv_file:
        score = row[2]
        if score != 'n/a' and score != 'Unknown' and score != 'CVSS_Two_Base_Score':
            score_number = float(score)
            score_list.append(score_number)
    print(len(score_list))
    print(score_list)
    average = 0
    sum = 0
    for num in score_list:
        sum = sum+num
    average = sum / len(score_list)
    for num in score_list:
        if num >= 0.0 and num <= 3.9:
            Low = Low + 1
        if num >= 4.0 and num <= 6.9:
            Medium = Medium + 1
        if num >= 7.0 and num <= 10.0:
            High = High + 1

    average = sum / len(score_list)
    print("Average of ", asset, len(score_list), "vulnerability modified v2 score is: ", average, "Low:", Low, "Medium:", Medium, "High:", High)


if  __name__ == '__main__':
    get_number_of_vulnerable_components()
    get_type_of_assets_vulnerable_components()
    get_type_of_assets_vulnerable_versions()
    get_category_of_asset_threat("rtu")
    get_cve_year_trend()
    get_vendor_trend()
    get_average_score_of_asset_threat_for_cvss_two("rtu")
